# src/agent/Dockerfile.tool-discovery - FIXED VERSION
FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && \
    apt-get install -y git && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    pip install --upgrade pip

WORKDIR /app

# Set environment variables
ENV PYTHONPATH=/app \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# Install Python dependencies (SAME as main agent + MCP)
RUN pip install --no-cache-dir \
    alembic>=1.12.0 \
    bcrypt==3.2.2 \
    fastapi>=0.103.1 \
    httpx>=0.25.0 \
    "opentelemetry-api>=1.31.1,<2.0.0" \
    openinference-instrumentation-mcp \
    opentelemetry-instrumentation-fastapi \
    opentelemetry-instrumentation-httpx \
    opentelemetry-instrumentation-threading \
    passlib>=1.7.4 \
    psycopg2-binary>=2.9.6 \
    pydantic>=2.4.2 \
    pydantic-settings>=2.0.3 \
    python-dotenv>=1.0.0 \
    "python-jose[cryptography]>=3.3.0" \
    python-multipart>=0.0.6 \
    sqlalchemy>=2.0.21 \
    uvicorn>=0.23.2 \
    "opentelemetry-sdk>=1.34.0,<2.0.0" \
    "opentelemetry-exporter-otlp>=1.34.0,<2.0.0" \
    aiohttp>=3.9.0 \
    beautifulsoup4>=4.12.0 \
    lxml>=4.9.0 \
    requests>=2.31.0

# Install MCP server dependencies
RUN pip install --no-cache-dir mcp

# Install fast-agent
RUN pip install --no-cache-dir git+https://github.com/acuvity/fast-agent.git

# Copy the application code
COPY . .

# Expose port
EXPOSE 8000

# Run the tool discovery MCP server (SSE version)
CMD ["python", "mcp_servers/tool_discovery_server_sse.py"]